---
title: 'Finding the ideal urban forest'
author: "Beau Lucas"
output:
  html_document:
    toc: true
    toc_float: false
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.asp = 0.618, fig.width = 7)
# options(device = "X11")
```

```{r}
library(foreign)
library(dplyr)
library(ggplot2)
library(sf)
library(kableExtra)
rogue::theme_mopub()

# add kable styling theme
```

```{r read in raw datasets}
states_dbf_raw <- foreign::read.dbf("./data/raw/states/States.dbf")
states_shp_raw <- sf::read_sf("./data/raw/states/States.shp")

county_shp_raw <- sf::read_sf("./data/raw/county_subdiv/CtySubdiv.shp") %>% janitor::clean_names()
county_dbf_raw <- foreign::read.dbf("./data/raw/county_subdiv/CtySubdiv.dbf") %>%
  as_tibble() %>%
  janitor::clean_names()
```

```{r early cleaning}
states_dbf <- states_dbf_raw %>%
  as_tibble() %>%
  janitor::clean_names() %>%
  mutate(
    prop_developed = tdevelop / lndrasar,
    prop_forest = tforest / lndrasar,
    prop_barren = tbarren / lndrasar,
    prop_shrub = tshrub / lndrasar,
    prop_ag = tagrcltr / lndrasar,
    prop_devcanopy = devcan / tdevelop,
    # rank stats
    forest_area_rank = dense_rank(desc(tforest)),
    pop_den_rank = dense_rank(desc(popden00)),
    pop_rank = dense_rank(desc(pop2000))
  ) %>%
  filter(name00 != "District of Columbia")
states_shp <- states_shp_raw %>%
  janitor::clean_names() %>%
  mutate(
    prop_developed = tdevelop / lndrasar,
    prop_forest = tforest / lndrasar
  )
county_shp <- county_shp_raw %>%
  mutate(prop_developed = tdevelop / lndrasar,
         prop_forest = tforest / lndrasar)
```

# Context

I decided to explore the topic of urban forests for a few reasons:

1. Curiosity around the quality and depth of .gov datasets. Thus far, I am impressed.
2. The beautiful maps I've seen on #Rstats twitter lately, including work done by folks at [r-spatial](https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html) and others
3. Personal motivation in exploring my long-term moving options

-----

# What is an urban forest?

Urban forests are areas of developed land that have ample greenspace and/or tree canopies. 

This analysis uses USDA land data to find out which states and metropolitan areas in the US showcase the best urban forests.

### Benefits of urban forests

```{r}
# TODO 
```

My idea of an urban forest is a state that exhibits the following properties:

- **Ample greenspace.** The state should contain large swaths of undeveloped land. This could take the form of mountains, forests, trails, etc. I need to be able to escape into large swaths of greenspace without driving half the day.

- **Canopies on developed land.** Suburban and urban areas should also be green. I don't want the [heat island effect](https://en.wikipedia.org/wiki/Urban_heat_island) effect, and want to feel more connected with nature where I live and work. California fails at this, as the majority of suburbs are concrete-dominant. Those that aren't are either far away from jobs (think remote Northern California) and/or wildfire risks. 

- **Reasonably, but not overly developed.** It should be easy to find a high-paying job, economy should be stable, and proximity to modern amenities should be seamless. This makes it urban.

-----

## Grabbing the data

This dataset is provided for free by the the [Northern Research Station of the USDA Forest Service](https://www.nrs.fs.fed.us/).

The data includes urban forest data with respect to the contiguous United States. The data was collected via *"...top-down aerial approaches and bottom-up field data collection"* as part of the [Resource Planning Act](https://www.fs.fed.us/research/rpa/).

Data is available at the state, county, and county sub-division level. The data consists of CSVs as well as GIS shapefiles.

A link to downloading the dataset can be found [here](https://www.nrs.fs.fed.us/data/urban/). To better understand the fields included in the data, there is also a helpful [metadata text file](https://www.nrs.fs.fed.us/data/urban/local-resources/documents/metasdata_shp.txt).

-----

## Ample greenspace

The first thing I want to do is filter out states that lack forested land. To me, ample greenspace is satisfied when the state has a large percentage of forest coverage combined with a large total area of forested land.

### Forest coverage

Looking at forest coverage, the first thing that pops out is the amount of forested land on the east coast compared to the west. To be fair, looking at the state level can penalize certain states that exhibit a wide variance in biomes. Judging `California` purely from this map, it would be difficult to realize that is the largest area of forested land in the contiguous United States.

```{r}
# scale_fc("#EED5B7", "#228B22", "#C1CDCD")
# TODO fix color coding
# TODO move fill scale to top
states_shp %>%
  #mutate(prop_forest = if_else(prop_forest < 0.2, NA_real_, prop_forest)) %>%
  ggplot() +
  geom_sf(aes(fill = prop_forest)) +
  scale_fill_gradient(low = "#EED5B7", high = "#228B22") +
  #scale_fill_viridis_c(end = 0.7) +
  labs(title = "The East Coast is draped in forest",
       fill = "Forest Proportion")

```

For a quick reduction, I'm going to filter out any state with forest coverage below `20%`.

#### Not Enough Forest

The eleven states that missed the mark seem to be either agricultural or full of shrubland. Most of these states are in the center of country.

```{r}
exclude_dev <- states_dbf %>%
  filter(prop_developed >= 0.10) %>%
  select(name00)

exclude_forest <- states_dbf %>%
  filter(prop_forest < 0.2) %>%
  select(name00)

excluded_states <- exclude_dev %>%
  union(exclude_forest)

states_dbf %>%
  filter(prop_forest < 0.2) %>%
  select(name00, prop_forest, prop_developed, prop_ag, prop_shrub, prop_barren) %>%
  arrange(desc(prop_forest)) %>%
  mutate_at(vars(contains("prop")), ~ scales::percent(., accuracy = 0.1)) %>%
  select(`State` = name00,
         `Prop Forest` = prop_forest,
         `Prop Developed` = prop_developed,
         `Prop Agriculture` = prop_ag,
         `Prop Shrub` = prop_shrub) %>%
  kable() %>%
  kable_styling()
```

### Total amount of forested land

We've removed states with low forest coverage. The next thing to check for is the total forested land mass of each state. This is a proxy for the ability to hike, access to national parks, and more.

Let's take a look at the states with the highest forest coverage and see how much forested land they actually have.

```{r}
states_dbf %>%
  select(name00, prop_forest, forest_area_rank, pop_den_rank, prop_developed) %>%
  arrange(desc(prop_forest)) %>%
  head(10) %>%
  mutate_at(vars(contains("prop")), ~ scales::percent(., accuracy = 0.1)) %>%
  select(`State` = name00,
         `Prop Forest` = prop_forest,
         `Forest Area Rank` = forest_area_rank,
         `Population Density Rank` = pop_den_rank,
         `Prop Developed` = prop_developed) %>%
  kable() %>%
  kable_styling()
```

Outside of `Alabama` and `Pennsylvania`, none of these states crack the top 10 in terms of forest land mass. 

We can visualize the difference between a state's forest coverage and how much of total US forest land the state contributes. 

```{r}
# TODO fix plot labels and colors
# TODO remove grid lines
states_dbf %>%
  mutate(
    prop_developed = tdevelop / lndrasar,
    prop_forest = tforest / lndrasar,
    prop_us_forest = tforest / sum(tforest)
  ) %>%
  ggplot(aes(x = prop_us_forest, y = prop_forest, colour = name00)) +
  geom_point(size = 3) +
  gghighlight::gghighlight((prop_forest > 0.4 & prop_us_forest < 0.01) |
    name00 == "California") +
  scale_colour_viridis_d() +
  labs(title = "Many of the heavily forested states are small",
       x = "State Proportion U.S. Forest Land",
       subtitle = "Proportion of state land that is forested (y)\nversus proportion of U.S. forest state contributes (x)") +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent)
```

There is a relationship between how much forest land a state has and how much US forest land the state constitutes. There are also exceptions to this. Notice the cluster of Northeastern states in the top-left quadrant. While these states are some of the most forested in the country, their small size limits their utility for those interested in the outdoors.

California, despite having the most amount of forested land in the contiguous US, barely cracks the `20%` forest threshold.

Secondly, these states are all sandwiched inside the [Northeast megalopolis](https://en.wikipedia.org/wiki/Northeast_megalopolis).

## Canopies on developed land

It's important that greenspace is present near places to live and work. There is [strong evidence](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5663018/) on the positive benefits greenspace has on the mental health of a population. It's important to be surrounded by greenspace without having to drive half of the day to the mountains.

In the underlying GIS data, there is a field `tdevelop`. Examining the metadata, `tdevelop` signals the total amount of developed land. Developed land follows classes 21-24 from the schema found here:

* [Multi-Resolution Land Characteristics Consortium](https://www.mrlc.gov/data/legends/national-land-cover-database-2011-nlcd2011-legend)

`tdevelop` thus captures a wide range of developments, from parks, single-family homes, and golf courses, all the way up to urban apartment complexes and factories. Since this is where most people will choose to live and work, measuring the amount of tree coverage in developed land is an important measure.

```{r, eval = FALSE}
# TODO show that most people live in developed land with little greenspace
county_dbf_raw %>% select(name00, popden00, pop2000, devcan, tdevelop) %>%
  mutate(develop_canopy_coverage = devcan / tdevelop) %>%
  filter(pop2000 > 100000) %>%
  ggplot(aes(x = popden00, y = develop_canopy_coverage)) +
  geom_point()

```

The dataset also contains a field `devcan`, which measures the amount of tree canopy in developed land.

There is a strong trend between how forested a state is and the canopy coverage on developed land, with some notable exceptions.

Let's compare how much of a state's land is covered by forest versus how much of its developed land is covered in canopy.

Notice the strong linear relationship between the two variables. I'm interested in filtering out states that have less than "expected" levels of developed canopy.

### Predicting developed canopy

Just for fun, let's fit a simple linear regression to determine which states exhibit less developed canopy than expected.

```{r}
# TODO clean up tibble logic
lm_canopy <- states_dbf %>%
  select(name00, prop_devcanopy, prop_forest) %>%
  filter(prop_forest > 0.2) %>%
  lm(data = ., prop_devcanopy ~ prop_forest)


canopy_fitted <- broom::augment(lm_canopy, data = states_dbf %>%
  select(name00, prop_devcanopy, prop_forest) %>%
  filter(prop_forest > 0.2)) %>%
  select(name00, starts_with("."))
```

```{r}
# TODO add exclusion zone
# TODO make red more earthy
# TODO make above average states green, below average more grey
states_dbf %>%
  select(name00, prop_devcanopy, prop_forest) %>%
  left_join(canopy_fitted, by = c("name00" = "name00")) %>%
  ggplot(aes(x = prop_forest, y = prop_devcanopy)) +
  geom_rect(aes(xmin = 0, xmax = 0.2, ymin = 0, ymax = 0.1), alpha = 1 / 100, colour = "#EE3B3B", fill = "#EE3B3B") +
  geom_line(aes(x = prop_forest, y = .fitted), colour = "#838B8B", linetype = "dashed") +
  geom_point(size = 3) +
  gghighlight::gghighlight(n = 1, max_highlight = 1, .resid < -0.06 | name00 == "California" | .resid > 0.08, label_key = name00) +

  labs(
    title = "Several high-forested states lack greenspace on developed land",
    subtitle = "How forested a state is versus how forested their developed land is",
    x = "State Forest Percentage",
    y = "Canopy Rate on Developed Land"
  ) +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent)
```

`Maine` and `Vermont` may be heavily forested, but their developed land is less green than less-forested states such as `Georgia` and `Mississippi`.

#### Developed Canopy vs. Total Canopy

```{r}
states_dbf %>%
  select(name00, devcan, canopy, tdevelop, lndrasar) %>%
  mutate(
    devcan_area_density = devcan / tdevelop,
    devcan_lndrasar_density = devcan / lndrasar,
    canopy_devcan_ratio = canopy / devcan,
    canopy_lndrasar_density = canopy / lndrasar
  ) %>%
  arrange(desc(devcan_area_density)) %>%
  ggplot(aes(x = devcan_area_density, y = canopy, colour = name00)) +
  geom_point() +
  gghighlight::gghighlight(
    canopy > 70000000000 | devcan_area_density > 0.25
  ) +
  geom_point(aes(size = devcan), pch = 21) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_y_continuous(labels = scales:::number_format(scale = 1 / 1000000000, accuracy = 1)) +
  labs(
    x = "Developed Canopy Coverage",
    y = "Total Canopy"
  ) +
  scale_colour_viridis_d(option = "A") +
  guides(size = FALSE)
```


We've now established two filters:

* Forest `>=20%` of land mass
* Developed canopy better than average

-----

## Reasonably, but not overly developed

A key part of the urban forest is the *urban* factor. We can measure this by looking at county-level demographics of forested states wi

* For myself, development cutoff is 10%

```{r}
# TODO fix ugly plot
states_shp %>%
  mutate(prop_developed = if_else(prop_developed > 0.1, NA_real_, prop_developed)) %>%
  ggplot() +
  geom_sf(aes(fill = prop_developed)) +
  scale_fill_viridis_c(option = "A", begin = 0.2)
```


## What's the deal with California?

Most of California is undeveloped, and it has the most forest land in the contiguous US. The problem is that a lot of this land is far away from economic and population centers. Weekend trips to Tahoe from the Bay Area are extremely common, but this forest is contained into mountainous, mostly undeveloped territory. Living there with modern amenities and proximity to high-skilled tech jobs is not possible.

```{r}
cali <- county_shp_raw %>%
  rename(`county` = name00) %>%
  inner_join(states_dbf %>% select(stfips, name00), by = c("stfips")) %>%
  filter(name00 %in% c("California")) %>%
  group_by(name00) %>%
  mutate(
    prop_develop = tdevelop / lndrasar,
    prop_forest = tforest / lndrasar
  ) %>%
  mutate(prop_develop = if_else(prop_develop < 0.05 | name00 != "California", NA_real_, prop_develop)) %>%
  ungroup()
```

If we look at the counties where people live, we get a different story.

Highlighted counties are those that contribute ~3/4 of California's population. The majority of California's forest land is highly remote.

```{r}
# TODO add brown agricultural part
cali_stats <- cali %>%
  arrange(desc(pop2000)) %>%
  mutate(
    cumsum_pop = cumsum(pop2000),
    cumprop_pop = cumsum_pop / sum(pop2000)
  ) %>%
  mutate(
    populated = if_else(cumprop_pop <= 0.75, TRUE, FALSE),
 #   prop_forest = if_else(prop_forest <= 0.1, NA_real_, prop_forest)
  )

# TODO add grey mexico
# TODO add labelso of major cities
# TODO make fill legend text smaller and remove plot border
cali_stats %>%
  select(county, pop2000, cumsum_pop, cumprop_pop, populated, prop_forest, popden00) %>%
  ggplot() +
  geom_sf(aes(fill = prop_forest), lwd=0) +
  # add strong border on populated counties
scale_fill_gradient(low = "#EED5B7", high = "#228B22", labels = scales::percent, breaks = c(0, 0.4, 0.8)) +
    geom_sf(data = cali_stats %>%
            filter(cumprop_pop <= 0.75), size = 1, alpha = 4 / 5, fill = "#CCCCCC", colour = "#828282") +
  labs(
    title = "California forests are far from population centers",
    subtitle = "Forest coverage compared to population centers (grey)",
    fill = "Country Forest Coverage"
  ) +
    geom_sf(data = states_shp %>% filter(name00 %in% c("Oregon", "Nevada", "Arizona", "Idaho"))) +
  coord_sf(crs = st_crs(4267),
             xlim = c(-125, -115), ylim = c(32, 43), expand = FALSE) +
  theme(panel.background = element_rect(fill = "aliceblue"),
        legend.position = "top")
```

```{r}
# TODO compare developed canopy of different state population centers
```

### Population Proportion vs. Land Mass

Another way to compare states is to see how the spread of its population across the total land mass.

```{r}

# TODO county with california
county_cali <- county_shp_raw %>%
  rename(`county` = name00) %>%
  inner_join(states_dbf %>% select(stfips, name00), by = c("stfips"))


# dist version
# population spread in overall area of land
# need to sum up county size
county_stats <- county_cali %>%
  group_by(name00) %>%
  arrange(desc(pop2000)) %>%
  mutate(
    cumsum_pop = cumsum(pop2000),
    cumsum_area = cumsum(lndrasar),
    cumprop_pop = cumsum_pop / sum(pop2000),
    cumprop_area = cumsum_area / sum(lndrasar),
    prop_develop = tdevelop / lndrasar,
  ) %>%
  select(name00, county, cumsum_pop, cumprop_pop, cumsum_area, cumprop_area)

# TODO remove grid lines
# TODO change label position
# rank them
most_skewed <- county_stats %>%
  filter(cumprop_pop >= 0.95) %>%
  filter(cumprop_area == min(cumprop_area)) %>%
  ungroup() %>%
  mutate(rank = rank(cumprop_area)) %>%
  arrange(rank) %>%
  filter(rank == 1 | rank == 48 | rank == 24 | name00 == "California") %>%
  as_tibble()
county_stats %>%
  left_join(most_skewed %>% select(name00, rank), by = c("name00")) %>%
  ggplot(aes(x = cumprop_pop, y = cumprop_area, colour = name00)) +
  geom_line(size = 1.25) +
  gghighlight::gghighlight(!is.na(rank)) +
  geom_abline(alpha = 1/3, linetype = "dashed") + 
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = "Cumulative Population %",
    y = "Cumulative Land Area %",
    title = "Nevada, California populations are concentrated on small area of the state"
  )
```

## Conclusion

